/*!
 * @module report
 * @author kael, chriscai
 * @date @DATE
 * Copyright (c) 2014 kael, chriscai
 * Licensed under the MIT license.
 */
var BJ_REPORT=(function(e){if(e.BJ_REPORT){return e.BJ_REPORT}var m=[];var j={id:0,uin:0,url:"",combo:1,ext:{},level:4,ignore:[],random:1,delay:1000,submit:null};var o=function(r,q){return Object.prototype.toString.call(r)==="[object "+(q||"Object")+"]"};var a=function(r){var q=typeof r;return q==="object"&&!!r};var i=function(q){if(q===null){return true}if(o(q,"Number")){return false}return !q};var p=e.onerror;e.onerror=function(v,u,q,t,s){var r=v;if(s&&s.stack){r=h(s)}if(o(r,"Event")){r+=r.type?("--"+r.type+"--"+(r.target?(r.target.tagName+"::"+r.target.src):"")):""}g.push({msg:r,target:u,rowNum:q,colNum:t});b();p&&p.apply(e,arguments)};var k=function(s){try{if(s.stack){var r=s.stack.match("https?://[^\n]+");r=r?r[0]:"";var u=r.match(":(\\d+):(\\d+)");if(!u){u=[0,0,0]}var q=h(s);return{msg:q,rowNum:u[1],colNum:u[2],target:r.replace(u[0],"")}}else{return s}}catch(t){return s}};var h=function(r){var q=r.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,5).join("@").replace(/\?[^:]+/gi,"");var s=r.toString();if(q.indexOf(s)<0){q=s+"@"+q}return q};var n=function(r,q){var w=[];var v=[];var x=[];if(a(r)){r.level=r.level||j.level;for(var s in r){var u=r[s];if(!i(u)){if(a(u)){try{u=JSON.stringify(u)}catch(t){u="[BJ_REPORT detect value stringify error] "+t.toString()}}x.push(s+":"+u);w.push(s+"="+encodeURIComponent(u));v.push(s+"["+q+"]="+encodeURIComponent(u))}}}return[v.join("&"),x.join(","),w.join("&")]};var f=[];var d=function(r){if(j.submit){j.submit(r)}else{var q=new Image();f.push(q);q.src=r}};var l=[];var c=0;var b=function(u){if(!j.report){return}while(m.length){var r=false;var w=m.shift();var q=n(w,l.length);if(o(j.ignore,"Array")){for(var t=0,s=j.ignore.length;t<s;t++){var x=j.ignore[t];if((o(x,"RegExp")&&x.test(q[1]))||(o(x,"Function")&&x(w,q[1]))){r=true;break}}}if(!r){if(j.combo){l.push(q[0])}else{d(j.report+q[2]+"&_t="+(+new Date))}j.onReport&&(j.onReport(j.id,w))}}var v=l.length;if(v){var y=function(){clearTimeout(c);d(j.report+l.join("&")+"&count="+v+"&_t="+(+new Date));c=0;l=[]};if(u){y()}else{if(!c){c=setTimeout(y,j.delay)}}}};var g={push:function(q){if(Math.random()>=j.random){return g}m.push(a(q)?k(q):{msg:q});b();return g},report:function(q){q&&g.push(q);b(true);return g},info:function(q){if(!q){return g}if(a(q)){q.level=2}else{q={msg:q,level:2}}g.push(q);return g},debug:function(q){if(!q){return g}if(a(q)){q.level=1}else{q={msg:q,level:1}}g.push(q);return g},init:function(q){if(a(q)){for(var r in q){j[r]=q[r]}}var s=parseInt(j.id,10);if(s){j.report=(j.url||"//badjs2.qq.com/badjs")+"?id="+s+"&uin="+(j.uin||parseInt((document.cookie.match(/\buin=\D+(\d+)/)||[])[1],10))+"&from="+encodeURIComponent(location.href)+"&ext="+JSON.stringify(j.ext)+"&"}return g},__onerror__:e.onerror};typeof console!=="undefined"&&console.error&&setTimeout(function(){var q=((location.hash||"").match(/([#&])BJ_ERROR=([^&$]+)/)||[])[2];q&&console.error("BJ_ERROR",decodeURIComponent(q).replace(/(:\d+:\d+)\s*/g,"$1\n"))},0);return g}(window));if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=BJ_REPORT}exports.BJ_REPORT=BJ_REPORT}(function(g){if(!g.BJ_REPORT){return}var e=function(m){g.BJ_REPORT.report(m)};var h=g.BJ_REPORT.tryJs=function l(m){m&&(e=m);return h};var k=function(o,n){var m;for(m in n){o[m]=n[m]}};var c=function(m){return typeof m==="function"};var f;var i=function(n,m){return function(){try{return n.apply(this,m||arguments)}catch(o){e(o);if(o.stack&&console&&console.error){console.error("[BJ-REPORT]",o.stack)}if(!f){var p=g.onerror;g.onerror=function(){};f=setTimeout(function(){g.onerror=p;f=null},50)}throw o}}};var d=function(m){return function(){var n,p=[];for(var q=0,o=arguments.length;q<o;q++){n=arguments[q];c(n)&&(n=i(n));p.push(n)}return m.apply(this,p)}};var a=function(m){return function(n,q){if(typeof n==="string"){try{n=new Function(n)}catch(p){throw p}}var o=[].slice.call(arguments,2);n=i(n,o.length&&o);return m(n,q)}};var b=function(n,m){return function(){var o,s,q=[];for(var r=0,p=arguments.length;r<p;r++){o=arguments[r];c(o)&&(s=i(o))&&(o.tryWrap=s)&&(o=s);q.push(o)}return n.apply(m||this,q)}};var j=function(o){var m,n;for(m in o){n=o[m];if(c(n)){o[m]=i(n)}}return o};h.spyJquery=function(){var p=g.$;if(!p||!p.event){return h}var o=p.event.add,n=p.ajax,m=p.event.remove;if(o){p.event.add=b(o);p.event.remove=function(){var q,s=[];for(var t=0,r=arguments.length;t<r;t++){q=arguments[t];c(q)&&(q=q.tryWrap);s.push(q)}return m.apply(this,s)}}if(n){p.ajax=function(q,r){if(!r){r=q;q=undefined}j(r);if(q){return n.call(p,q,r)}return n.call(p,r)}}return h};h.spyModules=function(){var m=g.require,n=g.define;if(n&&n.amd&&m){g.require=d(m);k(g.require,m);g.define=d(n);k(g.define,n)}if(g.seajs&&n){g.define=function(){var o,q=[];for(var r=0,p=arguments.length;r<p;r++){o=arguments[r];if(c(o)){o=i(o);o.toString=(function(s){return function(){return s.toString()}}(arguments[r]))}q.push(o)}return n.apply(this,q)};g.seajs.use=d(g.seajs.use);k(g.define,n)}return h};h.spySystem=function(){g.setTimeout=a(g.setTimeout);g.setInterval=a(g.setInterval);return h};h.spyCustom=function(m){if(c(m)){return i(m)}else{return j(m)}};h.spyAll=function(){h.spyJquery().spyModules().spySystem();return h}}(window));